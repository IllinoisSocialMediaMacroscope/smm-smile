$(document).ready(function(){
	
	$("#model").on('change',function(){
		//these model does not allow you to specify how many clusters
		var model = $(this).find(':selected').val()
		//console.log(model);
		if (model === 'AffinityPropagation' || model === 'DBSCAN' || model === 'MeanShift'){
			$("#clusters").hide();
		}else{
			$("#clusters").show();
		}
	});

	if (s3FolderName == undefined) s3FolderName = 'local';
	$.ajax({
		type:'POST',
		url:'list', 
		data: {"s3FolderName":s3FolderName},			
		success:function(data){
			if (data){
				if ('ERROR' in data){
					$("#loading").hide();
					$("#background").show();
					$("#error").val(JSON.stringify(data));
					$("#warning").modal('show');
				}else{
					$.each(data, function(key,val){
						if (key === 'twitter-Tweet' || key === 'twitter-Stream'){
							$("#selectFile").append($("<optgroup></optgroup>")
								.attr("label",key));
							$.each(val, function(key2,val2){
								$("#selectFile").find(`optgroup[label='` +key +`']`).after($("<option></option>")
									.attr("value", val2)
									.attr("class", key)
									.attr("id", key2)
									.text(key2));
							});
						}
					});	
					// show select and hide loading bar 4
					$("#selectFile").show();
					$("#selectLoading").hide();
				}
			}
		},
		error: function(jqXHR, exception){
			var msg = '';
			if (jqXHR.status === 0) {
				msg = 'Not connect.\n Verify Network.';
			} else if (jqXHR.status == 404) {
				msg = 'Requested page not found. [404]';
			} else if (jqXHR.status == 500) {
				msg = 'Internal Server Error [500].';
			} else if (exception === 'parsererror') {
				msg = 'Requested JSON parse failed.';
			} else if (exception === 'timeout') {
				msg = 'Time out error.';
			} else if (exception === 'abort') {
				msg = 'Ajax request aborted.';
			} else {
				msg = 'Uncaught Error.\n' + jqXHR.responseText;
			}
			$("#error").val(msg);
			$("#warning").modal('show');
			
		} 
	}); 
	
	$("#selectFile").on('change',function(){
		var prefix = $(this).children(":selected").val();
		$("#selectFilePreview-container").empty();

		// add loading bar here for preview
		$("#preview-loading").show();

		$.ajax({
			type:'POST',
			url:'render', 
			data: {"prefix":prefix},				
			success:function(data){
				if (data){
					if ('ERROR' in data){
						$("#loading").hide();
						$("#background").show();
						$("#error").val(JSON.stringify(data));
						$("#warning").modal('show');
					}else{
						var allowedFieldList = [
							// tweet
							'user.screen_name',
							'text',
							// stream
							'_source.user.screen_name',
							'_source.text'];

                        text_data = previewSelectedFile(allowedFieldList, data);
						// hide loading bar
						$("#preview-loading").hide();
						
						$("#selectFilePreview-container").append(`<div class="form-group">
						<label class="control-label col-md-2 col-md-2 col-xs-12">preview data</label>
						<div class="col-md-8 col-md-8 col-xs-12" id="selectFilePreview"></div></div>`)				
						$("#selectFilePreview").append(arrayToTable(text_data.slice(0, 11),'#selectFileTable'));
						//$("#selectFileTable").DataTable();
						
						$(".dataset").val(prefix);
						$(".length").val(text_data.length-1);
					}
					
				}					
			},
			error: function(jqXHR, exception){
				var msg = '';
				if (jqXHR.status === 0) {
					msg = 'Not connect.\n Verify Network.';
				} else if (jqXHR.status == 404) {
					msg = 'Requested page not found. [404]';
				} else if (jqXHR.status == 500) {
					msg = 'Internal Server Error [500].';
				} else if (exception === 'parsererror') {
					msg = 'Requested JSON parse failed.';
				} else if (exception === 'timeout') {
					msg = 'Time out error.';
				} else if (exception === 'abort') {
					msg = 'Ajax request aborted.';
				} else {
					msg = 'Uncaught Error.\n' + jqXHR.responseText;
				}
				$("#error").val(msg);
				$("#warning").modal('show');
				
			} 
		}); 
	});


	$("#relations").on('change',function(){
		$("#explanation-container").hide();
		$("#explanation-notice").empty();
		
		var relation = $(this).children(":selected").val();
		if (relation === 'retweet_from'){
			$("#explanation-notice").append(
				`<p><b>Retweet network</b> is a directional network. Nodes	in	
					this network represent the twitter users, while	the edges represent	the	retweets. 
					It is generated by extract the "RT @XXX" within the tweet.</p>`
			);
			$("#explanation-container").show();
		}else if (relation == 'reply_to'){
			$("#explanation-notice").append(
				`<p>A <b>reply relationship</b> is a special 
					form of “mention” that occurs when the user’s name is at the
					very start of a tweet (ex: <i>"@itaih just spoke about social media"</i> ). `
			);
			$("#explanation-container").show();
		}else if (relation == 'mentions'){
			$("#explanation-notice").append(
				`<p>A <b>mentions edge</b> is created when one user creates a tweet that contains the name
						of another user (indicated with a proceeding “@” character, 
						ex: <i>"just spoke about social media with @marc_smith"</i> ). </p>`
			);
			$("#explanation-container").show();
		}
		
	});
	
	$("#layout").on('change',function(){
		$("#citation-container").hide();
		$("#citation-notice").empty();
		
		var layout = $(this).children(":selected").val();
		if (layout !== 'Please Select...'){
			$("#citation-notice").append(
				`<p><b>Thank you for using our tool, if you use these results please cite it and the NetworkX Python library:</b></p>
				<ul>
					<li>Yun, J. T., Vance, N., Wang, C., Troy, J., Marini, L., Booth, R., Nelson, T., Hetrick, A., Hodgekins, H. (2018). 
					The Social Media Macroscope. In Gateways 2018.&nbsp<a href="https://doi.org/10.6084/m9.figshare.6855269.v2" target="_blank">
					https://doi.org/10.6084/m9.figshare.6855269.v2</a>
					</li>
					<li><a href="https://scholar.google.com/scholar?hl=en&as_sdt=0%2C14&q=
					Exploring+network+structure%2C+dynamics%2C+and+function+using+NetworkX&btnG=" target="_blank">
					Hagberg, A., Swart, P., & S Chult, D. (2008). Exploring network structure, dynamics, 
					and function using NetworkX (No. LA-UR-08-05495; LA-UR-08-5495). Los Alamos National Laboratory (LANL).</a>
					</li>
				</ul>
				<p><i>Large networks will be pruned to only display the 500 nodes with the highest degree centrality.</i></p>`
			);
			$("#citation-container").show();
		}
		
	});
	
	// lambda vs batch
	$("#submit").on('click',function(){
			if($(".length").val() === undefined){
				// pop error
				$("#modal-message").val("Cannot perform analysis on this dataset. Check if it exists!");
				$("#alert").modal('show');
			}else if ( $(".length").val() <= 5000 ){
				ajaxSubmit(`#analytics-config`,'lambda');
			}else{
				$("#aws-batch").modal('show');
			}
	});
	
});

/*----------------------form validation ----------------------------*/
function formValidation(aws_identifier){
	
	if ($("#selectFile option:selected").val() === 'Please Select...' || $("#selectFile option:selected").val() === undefined){
		$("#modal-message").append(`<h4>Please select a csv file from your folder!</h4>`);
		$("#alert").modal('show');
		$("#selectFile").focus();
		return false;
	}
	
	if ($("#selectFileTable thead tr").find('th').text() === ''){
		$("#modal-message").append(`<h4>This dataset you selected is empty, please select another one!</h4>`);
		$("#alert").modal('show');
		$("#selectFile").focus();
		return false;
	}
	
	// detect if both the text and the author is in the data
	var count = 0;
	$("#selectFileTable thead tr > th").each(function(){
		count += 1;
	});
	if (count !== 2){
		$("#modal-message").append(`<h4>This dataset you selected is not in compliance with Network Analysis Requirement. `+
		`Please select a dataset that has both "text" and "screen_name"!</h4>`);
		$("#alert").modal('show');
		$("#selectFile").focus();
		return false;
	}

	//console.log($("#relations option:selected").val());
	if ($("#relations option:selected").val() === 'Please Select...' || $("#relations option:selected").val() === undefined){
		$("#modal-message").append(`<h4>Please select a network relation!</h4>`);
		$("#alert").modal('show');
		$("#relations").focus();
		return false;
	}
	if ($("#layout option:selected").val() === 'Please Select...' || $("#layout option:selected").val() === undefined){
		$("#modal-message").append(`<h4>Please select a network layout!</h4>`);
		$("#alert").modal('show');
		$("#layout").focus();
		return false;
	}
	
	if (aws_identifier === 'batch'){
		if($(".dataset").val() === '' || $(".dataset").val() === undefined){
			$("#modal-message").append(`<h4>This dataset you select is invalid.</h4>`);
			$("#alert").modal('show');
			return false
		}
	
		if($(".length").val() === '' 
			|| $(".length").val() === undefined
			|| $(".length").val() === 0){
				$("#modal-message").append(`<h4>This dataset you select has no data!</h4>`);
				$("#alert").modal('show');
				return false
		}
	
		if($("#batch-email-alert").val() === '' 
			|| $("#batch-email-alert").val() === undefined 
			|| $("#batch-email-alert").val().indexOf('@')<= -1){
				$("#modal-message").append(`<h4>Please provide a valid email address so we can reach to you once your collection has completed!</h4>`);
				$("#alert").modal('show');
				return false
		}
	}
		
	return true;
	
}


